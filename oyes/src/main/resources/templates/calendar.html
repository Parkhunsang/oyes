<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" th:href="@{/style.css}">
    <title>Simple Calendar</title>
    <script type="text/javascript">
    const data = [];
    let calendarList = [];
    let doctor_id = "[[${doctor_id}]]";
    console.log(doctor_id);
    k1(doctor_id)  
    
 setTimeout(() => {
	k2()
	let date=new Date() //인스턴스 선언
	 
	//이번달 달력 생성
	renderCal(date)
 },300)

function k1(doctor_id) {
	$.post('/data','doctor_id='+doctor_id, function(item) {
	for(let i in item) {
		let imsi = {};
		imsi['date']=item[i].reservation_date.substring(0,10);
		imsi['content']=item[i].visit_type;
		data.push(imsi);		
	}
	console.log('k1 =',data);
	});
}
function k2() {
	calendarList = data.reduce(
	  (acc, v) => 
	    (	{ ...acc, [v.date]: [...(acc[v.date] || []), v.content] })
	  , {}
	);
	console.log('k2 =',calendarList)
}
//pad method
Number.prototype.pad = function() {
  return this > 9 ? this : '0' + this;
}
const renderCal=(date)=>{
  const viewYear=date.getFullYear() 
  const viewMonth=date.getMonth() + 1 //월은 0부터 시작하므로 +1해야됨.
  const viewDay=date.getDay() //요일은 일요일~토요일까지 0~6까지 표현된다.
      
  document.querySelector('.date-now').textContent=`${viewYear}년 ${viewMonth}월`
 
  const firstDay = new Date(date.setDate(1)).getDay();
  const lastDay = new Date(date.getFullYear(), date.getDay(), 0).getDate();
 
  const limitDay = firstDay + lastDay;
  const nextDay = Math.ceil(limitDay / 7) * 7;
 
  let htmlDummy = '';
  //날짜 아이템 생성
  for (let i = 0; i < firstDay; i++) {
    htmlDummy += '<div class="noColor"></div>';
  }
  for (let i = 1; i <= lastDay; i++) {  
      let date = `${viewYear}-${viewMonth.pad()}-${i.pad()}`  
      htmlDummy += `
      <div>${i}
        <p>${calendarList[date]?.join('</p><p>') || ''}
        </p>
      </div>`
    }
  for (let i = limitDay; i < nextDay; i++) {
    htmlDummy += `<div class="noColor"></div>`;
  }
  
  //HTML에 날짜 아이템 넣기
  document.querySelector(`.date-board`).innerHTML = htmlDummy;
  
}
 
// let date=new Date() //인스턴스 선언
 
//이번달 달력 생성
// renderCal(date)
 
//저번달 달력 생성
document.querySelector(`.date-last`).onclick=()=>{
  renderCal(new Date(date.setMonth(date.getMonth()-1)))
}
 
//다음달 달력 생성
document.querySelector(`.date-next`).onclick=()=>{
  renderCal(new Date(date.setMonth(date.getMonth()+1)))
}
    </script>
</head>
<body>
<div class='container'>
    <div class="header">
        <button class="date-last" id="btn">&lt;</button>
        <h2 class='date-now'></h2>
        <button class="date-next" id="btn">&gt;</button>
    </div>
    <div class="main">
        <div class="calendar">
            <div class="grid date-title">
                <!-- 그리드 각 블록을 div로 정의한다. -->
                <div>일</div>
                <div>월</div>
                <div>화</div>
                <div>수</div>
                <div>목</div>
                <div>금</div>
                <div>토</div>
            </div>
            <div class="grid date-board"></div>
        </div>
    </div>
    </div>
</body>
<!-- <script th:src="@{/index.js}"></script> -->
</html>